{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../src/controller/wechat/index.ts"],"names":[],"mappings":"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","sourcesContent":["'use strict';\r\n\r\nimport { Request,Response } from 'express';\r\nimport * as HttpRequest from \"request\";\r\nimport { sign,fetch,saveRedis,getRedis } from '../../common/utils';\r\nimport { resolve } from 'path';\r\nvar sha1 = require('sha1'); \r\nconst config = require('config-lite')(__dirname);\r\n\r\nexport default class Wechat {\r\n    getAccessToken() {\r\n        return new Promise((resolve,reject) => {\r\n            fetch({\r\n                method: \"get\",\r\n                url: `${config.wechat.prefix}/token?grant_type=client_credential&appid=${config.wechat.appID}&secret=${config.wechat.appSecret}`,\r\n            }).then((result:any) => {\r\n                var json:any;\r\n                \r\n                json = JSON.parse(result);\r\n                if (!json.access_token || json.errorcode) {\r\n                    reject(json);\r\n                    return;\r\n                }\r\n                json[\"timeStamp\"] = Date.now();\r\n                resolve(json);\r\n            }).catch((error) => {\r\n                reject(error)\r\n                throw new Error(error)\r\n            })\r\n        })\r\n    }\r\n    async sign(req:Request,res:Response) {\r\n        sign(req,res)\r\n    }\r\n    public async getMenu(req:Request,res:Response) {\r\n        const token = await getAccessToken()\r\n        fetch({\r\n            method:'get',\r\n            url:`${config.wechat.prefix}/menu/get?access_token=${token}`\r\n        }).then((result:any) => {\r\n            res.send(result)\r\n            return Promise.resolve(result)\r\n        }).catch((error) => {\r\n            return Promise.reject(error)\r\n        })\r\n    }\r\n    public async createMenu(req:Request,res:Response) {\r\n        console.log('123')\r\n        const token = await getAccessToken()\r\n        fetch({\r\n            method:'post',\r\n            url:`${config.wechat.prefix}/menu/create?access_token=${token}`,\r\n            body: {\r\n                \"button\":[\r\n                {    \r\n                     \"type\":\"click\",\r\n                     \"name\":\"今日歌曲\",\r\n                     \"key\":\"V1001_TODAY_MUSIC\"\r\n                 },\r\n                 {\r\n                      \"name\":\"菜单\",\r\n                      \"sub_button\":[\r\n                      {    \r\n                          \"type\":\"view\",\r\n                          \"name\":\"搜索\",\r\n                          \"url\":\"http://www.soso.com/\"\r\n                       },\r\n                       {\r\n                            \"type\":\"miniprogram\",\r\n                            \"name\":\"wxa\",\r\n                            \"url\":\"http://mp.weixin.qq.com\",\r\n                            \"appid\":\"wx286b93c14bbf93aa\",\r\n                            \"pagepath\":\"pages/lunar/index\"\r\n                        },\r\n                       {\r\n                          \"type\":\"click\",\r\n                          \"name\":\"赞一下我们\",\r\n                          \"key\":\"V1001_GOOD\"\r\n                       }]\r\n                  }]\r\n            }\r\n        }).then((result) => {\r\n            console.log(result)\r\n            res.send(result);\r\n            return Promise.resolve(result)\r\n        }).catch((error) => {\r\n            return Promise.reject(error)\r\n        })\r\n    }\r\n}\r\n\r\nexport function getAccessToken() {\r\n    return new Promise((resolve,reject) => {\r\n        getRedis(config.wechat.token)\r\n            .then((res) => {\r\n                resolve(res)\r\n            }).catch((error) => {\r\n                reject(error)\r\n                throw new Error(error)\r\n            })\r\n    }).then(res => new Promise((resolve,reject) => {\r\n        if(res) {\r\n            resolve(res)\r\n        } else {\r\n            new Wechat().getAccessToken().then((res:any) => {\r\n                saveRedis(config.wechat.token,res.access_token,7100)\r\n                    .then((success) => {\r\n                        resolve(res.access_token)\r\n                    }).catch((error:any) => {\r\n                        reject(error)\r\n                        throw new Error(error)\r\n                    })\r\n            }).catch((error) => {\r\n                reject(error)\r\n                throw new Error(error)\r\n            })\r\n        }\r\n    }))\r\n    .catch(error => {\r\n        throw new Error(error)\r\n    })\r\n}"]}